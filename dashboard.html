// =========================
// Configuración Supabase
// =========================
const SUPABASE_URL = "https://fzbheuoaxnenhrwadrvn.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6YmhldW9heG5lbmhyd2FkcnZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDUwOTMsImV4cCI6MjA3MDA4MTA5M30.49jF_IMBuvKt-HWpmN-9USgw6tDqUKzrW1uaOqNFi40"; // clave de ejemplo

// Crear cliente de Supabase
const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// =========================
// Estado de edición
// =========================
let editId = null;

// =========================
/** Helpers */
// =========================
function limpiarFormulario() {
  document.getElementById("nombre").value = "";
  document.getElementById("correo").value = "";
  document.getElementById("clase").value  = "";
}

// =========================
/** Crear / Actualizar estudiante */
// =========================
async function agregarEstudiante() {
  const nombre = document.getElementById("nombre").value.trim();
  const correo = document.getElementById("correo").value.trim();
  const clase  = document.getElementById("clase").value.trim();

  if (!nombre || !correo || !clase) {
    alert("Completa todos los campos.");
    return;
  }

  const { data: { user }, error: userError } = await client.auth.getUser();
  if (userError || !user) {
    alert("No estás autenticado.");
    return;
  }

  if (editId) {
    // UPDATE
    const { error } = await client
      .from("estudiantes")
      .update({ nombre, correo, clase })
      .eq("id", editId)
      .eq("user_id", user.id);

    if (error) {
      alert("Error al actualizar: " + error.message);
      return;
    }

    alert("Estudiante actualizado.");
    editId = null;
    const btn = document.getElementById("btn-guardar");
    if (btn) btn.textContent = "Guardar";
    limpiarFormulario();
    cargarEstudiantes();
    return;
  }

  // INSERT
  const { error } = await client.from("estudiantes").insert({
    nombre,
    correo,
    clase,
    user_id: user.id,
  });

  if (error) {
    alert("Error al agregar: " + error.message);
  } else {
    alert("Estudiante agregado");
    limpiarFormulario();
    cargarEstudiantes();
  }
}

// =========================
/** Cargar estudiantes (tabla con botones Editar y Eliminar) */
// =========================
async function cargarEstudiantes() {
  const { data, error } = await client
    .from("estudiantes")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    alert("Error al cargar estudiantes: " + error.message);
    return;
  }

  const tbody = document.getElementById("tabla-estudiantes");
  const empty = document.getElementById("empty-estudiantes");
  tbody.innerHTML = "";

  if (!data || data.length === 0) {
    if (empty) empty.classList.remove("d-none");
    return;
  } else {
    if (empty) empty.classList.add("d-none");
  }

  data.forEach((est, idx) => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td class="fw-semibold text-capitalize">${est.nombre}</td>
      <td><span class="badge bg-light text-dark border">${est.clase}</span></td>
      <td class="text-muted">${est.correo}</td>
      <td>
        <div class="btn-group btn-group-sm" role="group">
          <button class="btn btn-outline-primary btn-edit"
            data-id="${est.id}"
            data-nombre="${est.nombre}"
            data-correo="${est.correo}"
            data-clase="${est.clase}">
            <i class="fas fa-edit"></i> Editar
          </button>
          <button class="btn btn-outline-danger btn-delete" data-id="${est.id}">
            <i class="fas fa-trash-alt"></i> Eliminar
          </button>
        </div>
      </td>
    `;

    // Editar -> pasar a modo edición
    tr.querySelector(".btn-edit").addEventListener("click", (e) => {
      const btn = e.currentTarget;
      editId = btn.dataset.id;
      document.getElementById("nombre").value = btn.dataset.nombre;
      document.getElementById("correo").value = btn.dataset.correo;
      document.getElementById("clase").value  = btn.dataset.clase;
      const guardar = document.getElementById("btn-guardar");
      if (guardar) guardar.textContent = "Actualizar";
      document.getElementById("nombre").focus();
    });

    // Eliminar
    tr.querySelector(".btn-delete").addEventListener("click", (e) => {
      const id = e.currentTarget.dataset.id;
      eliminarEstudiante(id);
    });

    tbody.appendChild(tr);
  });
}

// =========================
/** Eliminar estudiante */
// =========================
async function eliminarEstudiante(id) {
  if (!confirm("¿Seguro que deseas eliminar este registro?")) return;

  const { data: { user }, error: userError } = await client.auth.getUser();
  if (userError || !user) {
    alert("No estás autenticado.");
    return;
  }

  const { error } = await client
    .from("estudiantes")
    .delete()
    .eq("id", id)
    .eq("user_id", user.id);

  if (error) {
    alert("Error al eliminar: " + error.message);
  } else {
    alert("Registro eliminado.");
    if (editId === id) {
      editId = null;
      const btn = document.getElementById("btn-guardar");
      if (btn) btn.textContent = "Guardar";
      limpiarFormulario();
    }
    cargarEstudiantes();
  }
}

// =========================
/** Subir archivo a Storage */
// =========================
async function subirArchivo() {
  const archivoInput = document.getElementById("archivo");
  const archivo = archivoInput.files[0];

  if (!archivo) {
    alert("Selecciona un archivo primero.");
    return;
  }

  const { data: { user }, error: userError } = await client.auth.getUser();
  if (userError || !user) {
    alert("Sesión no válida.");
    return;
  }

  const nombreRuta = `${user.id}/${archivo.name}`;
  const { error } = await client.storage
    .from("tareas") // Nombre del bucket
    .upload(nombreRuta, archivo, {
      cacheControl: "3600",
      upsert: false,
    });

  if (error) {
    alert("Error al subir: " + error.message);
  } else {
    alert("Archivo subido correctamente.");
    listarArchivos();
  }
}

// =========================
/** Listar archivos del usuario */
// =========================
async function listarArchivos() {
  const { data: { user }, error: userError } = await client.auth.getUser();

  if (userError || !user) {
    alert("Sesión no válida.");
    return;
  }

  const { data, error } = await client.storage
    .from("tareas")
    .list(`${user.id}`, { limit: 20 });

  const lista = document.getElementById("lista-archivos");
  lista.innerHTML = "";

  if (error) {
    lista.innerHTML = "<li>Error al listar archivos</li>";
    return;
  }

  // Render de cada archivo con URL firmada
  data.forEach(async (archivo) => {
    const { data: signedUrlData, error: signedUrlError } = await client.storage
      .from("tareas")
      .createSignedUrl(`${user.id}/${archivo.name}`, 60);

    if (signedUrlError) {
      console.error("Error al generar URL firmada:", signedUrlError.message);
      return;
    }

    const publicUrl = signedUrlData.signedUrl;

    const item = document.createElement("li");

    const esImagen = archivo.name.match(/\.(jpg|jpeg|png|gif)$/i);
    const esPDF = archivo.name.match(/\.pdf$/i);

    if (esImagen) {
      item.innerHTML = `
        <strong>${archivo.name}</strong><br>
        <a href="${publicUrl}" target="_blank">
          <img src="${publicUrl}" width="150" style="border:1px solid #ccc; margin:5px;" />
        </a>
      `;
    } else if (esPDF) {
      item.innerHTML = `
        <strong>${archivo.name}</strong><br>
        <a href="${publicUrl}" target="_blank">Ver PDF</a>
      `;
    } else {
      item.innerHTML = `<a href="${publicUrl}" target="_blank">${archivo.name}</a>`;
    }

    lista.appendChild(item);
  });
}

// =========================
/** Cerrar sesión */
// =========================
async function cerrarSesion() {
  const { error } = await client.auth.signOut();

  if (error) {
    alert("Error al cerrar sesión: " + error.message);
  } else {
    localStorage.removeItem("token");
    alert("Sesión cerrada.");
    window.location.href = "index.html";
  }
}

// =========================
// Inicialización
// =========================
cargarEstudiantes();
